<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Finalizar Compra - Market Chasoy</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
  </head>
  <body class="bg-light">
    <!-- Barra de Navegación -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <!-- ... (tu barra de navegación) ... -->
    </nav>

    <div class="container my-5">
      <div class="row g-5">
        <!-- Columna del Resumen del Pedido -->
        <div class="col-md-5 col-lg-4 order-md-last">
          <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-primary">Tu Carrito</span>
            <span
              class="badge bg-primary rounded-pill"
              th:text="${session.carrito != null ? session.carrito.getCantidadItems() : 0}"
              >0</span
            >
          </h4>
          <ul class="list-group mb-3">
            <li
              th:each="item : ${session.carrito?.items}"
              class="list-group-item d-flex justify-content-between lh-sm"
            >
              <div>
                <h6 class="my-0" th:text="${item.nombre}">Nombre Producto</h6>
              </div>
              <span
                class="text-muted"
                th:text="'$' + ${#numbers.formatDecimal(item.precio, 1, 'POINT', 2, 'POINT')}"
              ></span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Total (COP)</span>
              <strong
                th:text="'$' + ${#numbers.formatDecimal(session.carrito != null ? session.carrito.getTotal() : 0.0, 1, 'POINT', 2, 'POINT')}"
                >$0.00</strong
              >
            </li>
          </ul>
        </div>

        <!-- Columna del Formulario de Pago -->
        <div class="col-md-7 col-lg-8">
          <h4 class="mb-3">Información de Pago</h4>
          <form id="payment-form" th:action="@{/pagar}" method="post">
            <!-- Elemento donde Stripe montará el formulario de tarjeta -->
            <div id="payment-element" class="mb-3"></div>

            <!-- Div para mostrar errores de pago -->
            <div id="payment-message" class="text-danger"></div>

            <button id="submit" class="w-100 btn btn-primary btn-lg">
              <div
                class="spinner-border spinner-border-sm d-none"
                role="status"
              ></div>
              <span>Pagar Ahora</span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Incluimos la librería de Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Nuestro script para inicializar Stripe -->
    <!-- ... en checkout.html ... -->
    <script src="https://js.stripe.com/v3/"></script>
    <script th:inline="javascript">
      // Usamos 'if' para asegurarnos de que el script solo se ejecuta si los datos existen.
      if (document.getElementById("payment-form")) {
        // Obtenemos la clave pública y el client secret desde el controlador.
        const stripePublicKey = /*[[${stripePublicKey}]]*/ null;
        const clientSecret = /*[[${clientSecret}]]*/ null;

        // Verificamos que los datos necesarios para Stripe llegaron del backend.
        if (!stripePublicKey || !clientSecret) {
          console.error(
            "Faltan las claves de Stripe. El backend falló al crear el Payment Intent."
          );
          document.getElementById("payment-message").textContent =
            "No se pudo cargar el formulario de pago. Por favor, intente de nuevo.";
        } else {
          const stripe = Stripe(stripePublicKey);

          let elements = stripe.elements({ clientSecret });
          const paymentElement = elements.create("payment");
          paymentElement.mount("#payment-element"); // Montamos el formulario de tarjeta

          const form = document.getElementById("payment-form");
          form.addEventListener("submit", async (event) => {
            event.preventDefault();

            // Mostramos un spinner y deshabilitamos el botón para evitar clics múltiples
            document.querySelector("#submit span").classList.add("d-none");
            document
              .querySelector("#submit .spinner-border")
              .classList.remove("d-none");
            document.getElementById("submit").disabled = true;

            // Confirmamos el pago del lado del cliente con Stripe
            const { error } = await stripe.confirmPayment({
              elements,
              confirmParams: {
                return_url: window.location.origin + "/resultado-pago",
              },
            });

            if (error) {
              // Si hay un error (ej. tarjeta inválida), lo mostramos.
              document.getElementById("payment-message").textContent =
                error.message;
              // Habilitamos el botón de nuevo
              document.querySelector("#submit span").classList.remove("d-none");
              document
                .querySelector("#submit .spinner-border")
                .classList.add("d-none");
              document.getElementById("submit").disabled = false;
            }
          });
        }
      }
    </script>
  </body>
</html>
